# Caption Types Documentation

## Overview

This document details the implementation of Task 3.4: "Add support for auto-generated and manual captions" for the YT Article Craft project. The system now distinguishes between different caption types, extracts additional metadata, and provides special handling for auto-generated captions with speaker identification.

## Types of Captions

The system now supports and distinguishes between the following caption types:

| Caption Type | Description | Features |
|--------------|-------------|----------|
| `manual` | Manually uploaded captions | Generally higher quality, may include translations |
| `auto_generated` | Automatically generated by YouTube | May include speaker identification, lower quality |
| `translated` | Manually translated captions | Derived from another language |

## Enhanced Metadata Model

The `CaptionMetadata` class has been extended with the following fields:

```python
@dataclass
class CaptionMetadata:
    language_code: str
    language_name: str
    is_auto_generated: bool
    format: str
    source_url: str
    video_id: str
    caption_type: str = "unknown"  # "manual", "auto_generated", "translated", etc.
    has_speaker_identification: bool = False
    quality_score: Optional[float] = None  # Estimated quality of auto captions (0-1)
    provider: str = "youtube"  # Source provider of captions
    is_default: bool = False  # Whether this is the default caption track
```

## Speaker Identification

Auto-generated captions often include speaker identification in different formats:

1. VTT voice tags: `<v Speaker 1>Text</v>`
2. Speaker prefixes: `[SPEAKER 1]: Text`
3. Bracketed speakers: `[John] Text`

The enhanced `VttParser` in `subtitle_parser.py` detects these patterns and:

1. Preserves speaker information when cleaning text
2. Sets the `has_speaker_identification` flag in the metadata
3. Formats text consistently with appropriate speaker prefixes

## YtDlpWrapper Enhancements

The `YtDlpWrapper` class now provides:

1. Enhanced subtitle listing with detailed caption type information
2. Improved subtitle downloading with source-specific handling
3. Detection of speaker identification markers in downloaded captions
4. Default caption track identification

Example usage:

```python
wrapper = YtDlpWrapper()
captions = wrapper.list_subtitles("https://www.youtube.com/watch?v=dQw4w9WgXcQ")
print(captions['automatic'])  # Shows auto-generated captions with speaker info
print(captions['manual'])     # Shows manually uploaded captions
```

## CaptionService Features

The `CaptionService` class now provides methods to:

1. Filter available captions by type:
   ```python
   service.filter_captions_by_type(captions_info, 'manual')
   ```

2. Find captions with speaker identification:
   ```python
   service.has_speaker_identification(captions_info)
   ```

3. Get the default caption track:
   ```python
   service.get_default_caption(captions_info)
   ```

4. Use enhanced metadata when getting captions:
   ```python
   caption = service.get_caption(url, language="en", source="auto_generated")
   print(f"Has speakers: {caption.metadata.has_speaker_identification}")
   ```

## Testing

The implementation includes unit tests in `tests/test_caption_types.py` that verify:

1. Detection of speaker identification in auto-generated captions
2. Filtering and handling of different caption types
3. Appropriate metadata population during download and parsing

Run the tests with:

```bash
python tests/test_caption_types.py
```

## Usage Examples

### Getting Auto-Generated Captions with Speaker Information

```python
from services import CaptionService, YtDlpWrapper

yt_dlp = YtDlpWrapper()
service = CaptionService(yt_dlp_wrapper=yt_dlp, cache_dir="./cache")

# Get available captions
video_url = "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
available = service.get_available_captions(video_url)

# Find captions with speaker identification
speaker_captions = service.has_speaker_identification(available)
if speaker_captions:
    # Get the first caption with speaker identification
    caption = service.get_caption(
        url=video_url,
        language=speaker_captions[0]['language'],
        source="automatic"
    )
    
    # Print the caption text with speaker information
    print(caption.to_plain_text())
```

### Comparing Manual vs. Auto-Generated Captions

```python
# Get both types of captions for comparison
manual_caption = service.get_caption(url=video_url, language="en", source="manual")
auto_caption = service.get_caption(url=video_url, language="en", source="automatic")

# Compare metadata
print(f"Manual caption type: {manual_caption.metadata.caption_type}")
print(f"Auto caption type: {auto_caption.metadata.caption_type}")
print(f"Manual has speakers: {manual_caption.metadata.has_speaker_identification}")
print(f"Auto has speakers: {auto_caption.metadata.has_speaker_identification}")

# Compare content
print("Manual caption preview:")
print(service.get_caption_preview(manual_caption))
print("Auto caption preview:")
print(service.get_caption_preview(auto_caption))
```

## Future Extensions

The current implementation can be extended in the following ways:

1. Add quality estimation for auto-generated captions
2. Implement AI-based speaker diarization for captions without speaker information
3. Support merging/synchronizing multiple caption tracks
4. Add customizable speaker detection patterns 